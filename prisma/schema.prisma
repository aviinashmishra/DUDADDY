generator client {
    provider        = "prisma-client-js"
    previewFeatures = ["driverAdapters"]
}

datasource db {
    provider  = "postgresql"
    url       = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")
}

// Required for creating a User: id, name, email, image, cart (optional JSON string)
model User {
    id            String    @id
    name          String
    email         String    @unique
    emailVerified DateTime?
    image         String?
    password      String?   // For password-based authentication
    cart          Json      @default("{}")
    role          String    @default("user")
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt

    // Relations
    ratings     Rating[]
    Address     Address[]
    store       Store?
    buyerOrders Order[]   @relation("BuyerRelation")
    accounts    Account[]
    sessions    Session[]
    passwordResetTokens PasswordResetToken[]
    
    // Profile Management Relations
    profile        UserProfile?
    preferences    UserPreferences?
    paymentMethods SavedPaymentMethod[]
    supportTickets SupportTicket[]
}

model PasswordResetToken {
    id        String   @id @default(cuid())
    userId    String
    token     String   @unique
    expiresAt DateTime
    used      Boolean  @default(false)
    createdAt DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([token])
    @@index([userId])
}

model Account {
    id                String  @id @default(cuid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String?
    access_token      String?
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String?
    session_state     String?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}

model OTP {
    id        String   @id @default(cuid())
    email     String
    otp       String
    expiresAt DateTime
    verified  Boolean  @default(false)
    createdAt DateTime @default(now())

    @@index([email])
}

// Required for creating a Product: name, description, mrp, price, images, category, storeId
model Product {
    id          String   @id @default(cuid())
    name        String
    description String
    mrp         Float
    price       Float
    images      String[]
    category    String
    inStock     Boolean  @default(true)
    storeId     String
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    // Relations
    store      Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
    orderItems OrderItem[]
    rating     Rating[]
}

enum OrderStatus {
    ORDER_PLACED
    PROCESSING
    SHIPPED
    DELIVERED
}

enum PaymentMethod {
    COD
    STRIPE
}

// Required for creating an Order: total, userId, storeId, addressId, isPaid, paymentMethod, isCouponUsed, coupon (JSON), orderItems (nested)
model Order {
    id            String        @id @default(cuid())
    total         Float
    status        OrderStatus   @default(ORDER_PLACED)
    userId        String
    storeId       String
    addressId     String
    isPaid        Boolean       @default(false)
    paymentMethod PaymentMethod
    createdAt     DateTime      @default(now())
    updatedAt     DateTime      @updatedAt
    isCouponUsed  Boolean       @default(false)
    coupon        Json          @default("{}")
    orderItems    OrderItem[]

    // Relations
    user    User    @relation("BuyerRelation", fields: [userId], references: [id])
    store   Store   @relation(fields: [storeId], references: [id])
    address Address @relation(fields: [addressId], references: [id])
}

// Required for creating an OrderItem: orderId, productId, quantity, price
model OrderItem {
    orderId   String
    productId String
    quantity  Int
    price     Float

    // Relations
    order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
    product Product @relation(fields: [productId], references: [id])

    @@id([orderId, productId])
}

// Required for creating a Rating: rating, review, userId, productId
model Rating {
    id        String   @id @default(cuid())
    rating    Int
    review    String
    userId    String
    productId String
    orderId   String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

    @@unique([userId, productId, orderId])
}

// Required for creating an Address: userId, name, email, street, city, state, zip, country, phone
model Address {
    id           String      @id @default(cuid())
    userId       String
    type         AddressType @default(HOME)
    label        String?     // Custom label for address
    firstName    String
    lastName     String
    email        String
    addressLine1 String      // Renamed from street
    addressLine2 String?     // Additional address line
    city         String
    state        String
    postalCode   String      // Renamed from zip
    country      String
    phone        String
    isDefault    Boolean     @default(false)
    createdAt    DateTime    @default(now())
    updatedAt    DateTime    @updatedAt

    // Relations
    Order Order[]
    user  User    @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([isDefault])
}

// Required for creating a Coupon: code, description, discount, forNewUser, isPublic, expiresAt
model Coupon {
    code        String   @id
    description String
    discount    Float
    forNewUser  Boolean
    forMember   Boolean  @default(false)
    isPublic    Boolean
    expiresAt   DateTime
    createdAt   DateTime @default(now())
}

// Required for creating a Store: userId, name, username, email, contact, logo, description, address (optional: , status, isActive)
model Store {
    id          String   @id @default(cuid())
    userId      String   @unique
    name        String
    description String
    username    String   @unique
    address     String
    status      String   @default("pending")
    isActive    Boolean  @default(false)
    logo        String
    email       String
    contact     String
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    Product Product[]
    Order   Order[]
    user    User      @relation(fields: [userId], references: [id])
}

// Profile Management Models

model UserProfile {
    id           String    @id @default(cuid())
    userId       String    @unique
    firstName    String?
    lastName     String?
    phone        String?
    dateOfBirth  DateTime?
    profilePicture String?
    bio          String?
    createdAt    DateTime  @default(now())
    updatedAt    DateTime  @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserPreferences {
    id                String   @id @default(cuid())
    userId            String   @unique
    emailNotifications Boolean @default(true)
    smsNotifications  Boolean  @default(false)
    marketingEmails   Boolean  @default(true)
    orderUpdates      Boolean  @default(true)
    promotionalOffers Boolean  @default(true)
    dataSharing       Boolean  @default(false)
    twoFactorEnabled  Boolean  @default(false)
    language          String   @default("en")
    currency          String   @default("INR")
    timezone          String   @default("Asia/Kolkata")
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum AddressType {
    HOME
    WORK
    BILLING
    SHIPPING
    CUSTOM
}

enum PaymentType {
    CARD
    WALLET
    BANK
}

model SavedPaymentMethod {
    id            String      @id @default(cuid())
    userId        String
    type          PaymentType
    provider      String      // visa, mastercard, paypal, etc.
    maskedNumber  String      // Last 4 digits or masked info
    expiryMonth   Int?
    expiryYear    Int?
    holderName    String?
    isDefault     Boolean     @default(false)
    isExpired     Boolean     @default(false)
    encryptedData String      // Encrypted payment details
    createdAt     DateTime    @default(now())
    updatedAt     DateTime    @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
}

enum SupportCategory {
    ORDER_ISSUE
    PAYMENT_ISSUE
    PRODUCT_ISSUE
    ACCOUNT_ISSUE
    TECHNICAL_ISSUE
    GENERAL_INQUIRY
    RETURN_REQUEST
    REFUND_REQUEST
}

enum TicketStatus {
    OPEN
    IN_PROGRESS
    WAITING_FOR_CUSTOMER
    RESOLVED
    CLOSED
}

enum TicketPriority {
    LOW
    MEDIUM
    HIGH
    URGENT
}

model SupportTicket {
    id          String          @id @default(cuid())
    userId      String
    orderId     String?
    category    SupportCategory
    subject     String
    description String
    status      TicketStatus    @default(OPEN)
    priority    TicketPriority  @default(MEDIUM)
    attachments String[]        @default([])
    createdAt   DateTime        @default(now())
    updatedAt   DateTime        @updatedAt

    user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)
    responses SupportTicketResponse[]

    @@index([userId])
    @@index([status])
}

model SupportTicketResponse {
    id        String   @id @default(cuid())
    ticketId  String
    message   String
    isFromUser Boolean @default(true)
    createdAt DateTime @default(now())

    ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

    @@index([ticketId])
}
